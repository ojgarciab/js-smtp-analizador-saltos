<!doctype html>
<html lang="es">
  <head>
    <!-- Meta tags requeridos -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS de Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Analizador de saltos SMTP</title>
    <style>
        textarea {
            display: block;
            width: 100%;
            height: 10rem;
            margin-bottom: 1rem;
            line-height: normal;
        }
        .container {
            padding-top: 2rem;
        }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Cabeceras SMTP</h1>
      <p class="lead">Introduzca aquí las cabeceras de su mensaje.</p>
      <textarea id="smtp"></textarea>
      <button class="btn btn-primary" id="analizar">Analizar cabeceras</button>
    </div>
    <div class="container">
        <p class="lead">Resultados:</p>
        <table class="table">
        <thead>
          <tr>
            <th scope="col">Cabecera</th>
            <th scope="col">Origen</th>
            <th scope="col">Destino</th>
            <th scope="col">Hora</th>
            <th scope="col">Latencia</th>
          </tr>
        </thead>
        <tbody>
            <tr><th colspan="5">No hay datos que mostrar</th></tr>
        </tbody>
      </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /* Precargamos los elementos por "id" */
            let smtp = document.getElementById('smtp');
            let analizar = document.getElementById('analizar');
            /* Cada vez que cambie "smtp" actualizamos su valor para su restauración */
            smtp.addEventListener('change', () => {
                localStorage.setItem('smtp', smtp.value);
            });
            /* Cada vez que pulsemos en el botón analizamos las cabeceras */
            analizar.addEventListener('click', () => {
                /* Patrón de búsqueda de cabeceras y sus partes */
                let cabeceraRegexp = /^(Date|Received):[\s]+(.*)$/i;
                let receivedFromRegexp = /from ([^\s]+)/i;
                let receivedByRegexp = /by ([^\s]+)/i;
                let receivedDateRegexp = /;?(?:.*,)[\s]*([^;]+)$/i;
                /* Unimos las cabeceras multilínea */
                let cabeceras = smtp.value.replace(/[\n\r]+[\t ]+/mg, ' ').split('\n');
                /* Inicializamos los saltos con un conjunto vacío de datos */
                let saltos = {
                    date: {
                        elementos: [],
                    },
                    received: {
                        elementos: [],
                    }
                };
                cabeceras.forEach(cabecera => {
                    let componentes = cabecera.match(cabeceraRegexp);
                    if (componentes === null) return;
                    let from = componentes[2].match(receivedFromRegexp);
                    let by = componentes[2].match(receivedByRegexp);
                    let date = componentes[2].match(receivedDateRegexp);
                    saltos[componentes[1].toLowerCase()].elementos.unshift({
                        cabecera: componentes[1].toLowerCase(),
                        from: from ? from[1] : false,
                        by: by ? by[1] : false,
                        date: date ? new Date(date[1]) : false,
                    });
                });
                /* Limpiamos la tabla */
                let tabla = document.querySelector('.table tbody');
                tabla.textContent = '';
                /* Inicialmente no hay hora anterior */
                let anterior = false;
                /* Concatenamos los datos y generamos las filas de la tabla */
                saltos.date.elementos.concat(saltos.received.elementos).forEach(elemento => {
                    let tr = document.createElement('tr');
                    let td = [
                        document.createElement('td'),
                        document.createElement('td'),
                        document.createElement('td'),
                        document.createElement('td'),
                        document.createElement('td'),
                    ];
                    td[0].innerText = elemento.cabecera[0].toUpperCase() + elemento.cabecera.slice(1);
                    td[1].innerText = elemento.from;
                    td[2].innerText = elemento.by;
                    td[3].innerText = elemento.date.toLocaleString();
                    if (anterior === false) {
                        td[4].innerText = '-';
                    } else {
                        td[4].dataset.latencia = (elemento.date.getTime() - anterior.getTime()) / 1000;
                    }
                    td.forEach(elemento => tr.appendChild(elemento));
                    tabla.appendChild(tr);
                    anterior = elemento.date;
                });
                /* Dependiendo de la latencia cambiamos el color de la fila */
                document.querySelectorAll('td[data-latencia]').forEach(elemento => {
                    elemento.innerText = elemento.dataset.latencia + "s";
                    if (elemento.dataset.latencia < 10) {
                        elemento.parentNode.style.color = 'darkgreen';
                    } else if (elemento.dataset.latencia < 60) {
                        elemento.parentNode.style.color = 'green';
                    } else {
                        if (elemento.dataset.latencia < 120) {
                            elemento.parentNode.style.color = 'darkorange';
                        } else if (elemento.dataset.latencia < 300) {
                            elemento.parentNode.style.color = 'darkred';
                        } else {
                            elemento.parentNode.style.color = 'red';
                        }
                        elemento.innerText = Math.floor(elemento.dataset.latencia / 60) + "m" + (elemento.dataset.latencia % 60) + "s";
                    }
                });
            });
            /* Restauramos el valor previo del campo "smtp" y pulsamos en analizar */
            smtp.value = localStorage.getItem('smtp');
            analizar.click();
        });
    </script>

    <!-- JavaScript opcional -->
    <!-- Primero jQuery, después Popper.js y por último el JS de Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>